<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Meal Tracker</title>
  <!-- Apple icon tags FIRST so Safari grabs them before anything else loads -->
  <link rel="apple-touch-icon" sizes="180x180" href="/meal-tracker/apple-touch-icon.png">
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/meal-tracker/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-title" content="Meals" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="/meal-tracker/manifest.json" />
  <meta name="theme-color" content="#167188" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script>
    tailwind.config = {
      theme: { extend: { colors: {
        brand: { 50: '#f0f7f9', 100: '#daebf1', 500: '#167188', 900: '#0D4250' },
        accent: '#FF6B6B', neutral: '#7E7F7F'
      } } }
    }
  </script>
  <style>
    body { padding-bottom: env(safe-area-inset-bottom); background: #f0f7f9; -webkit-tap-highlight-color: transparent; }
    html { overscroll-behavior: none; }
    button, nav { -webkit-user-select: none; user-select: none; }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .food-card { transition: all 0.1s ease; border-width: 2px; }
    .food-card:active { transform: scale(0.98); }
    .selected-card { border-color: #167188 !important; background-color: #daebf1 !important; }
  </style>
</head>
<body class="text-slate-800 tracking-tight">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useReducer, useCallback, useMemo, useRef } = React;

    // --- DB WRAPPER ---
    const DB_NAME = 'MealTrackerDB';
    const dbSave = async (key, data) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onsuccess = (e) => {
        const db = e.target.result;
        const tx = db.transaction('appData', 'readwrite');
        tx.objectStore('appData').put(data, key);
      };
    };
    const dbLoad = (key, defaultValue) => {
      return new Promise((resolve) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => e.target.result.createObjectStore('appData');
        request.onsuccess = (e) => {
          const tx = e.target.result.transaction('appData', 'readonly');
          const req = tx.objectStore('appData').get(key);
          req.onsuccess = () => resolve(req.result || defaultValue);
          req.onerror = () => resolve(defaultValue);
        };
      });
    };

    // --- Constants ---
    const generateId = () => Math.random().toString(36).substring(2, 15);
    const getTodayStr = () => new Date().toLocaleDateString('en-CA');

    const CATEGORIES = [
      { id: 'carb', label: 'Carb', color: 'bg-amber-100 text-amber-800 border-amber-300', aisle: 'Pantry' },
      { id: 'protein', label: 'Protein', color: 'bg-red-100 text-red-800 border-red-300', aisle: 'Meat/Dairy' },
      { id: 'fruit',   label: 'Fruit',   color: 'bg-purple-100 text-purple-800 border-purple-300', aisle: 'Produce' },
      { id: 'veggie',  label: 'Veggie',  color: 'bg-green-100 text-green-700 border-green-300', aisle: 'Produce' },
      { id: 'snack',   label: 'Snack',   color: 'bg-blue-100 text-blue-800 border-blue-300', aisle: 'Snacks' },
    ];
    const BALANCE_CATEGORIES = ['carb', 'protein', 'fruit', 'veggie'];

    // Preference tiers derived from computed eating scores
    // Score = average points from servings in last 6 months
    // Points: none=0, some=5, all=10
    const RATINGS = [
      { id: 'loves',    icon: 'ph-fill ph-heart',        color: 'text-accent',    label: 'Loves',    min: 7.5 },
      { id: 'likes',    icon: 'ph-fill ph-thumbs-up',    color: 'text-brand-500', label: 'Likes',    min: 5 },
      { id: 'meh',      icon: 'ph-fill ph-minus-circle',  color: 'text-neutral',   label: 'Meh',      min: 2.5 },
      { id: 'dislikes', icon: 'ph-fill ph-thumbs-down',   color: 'text-brand-900', label: 'Dislikes', min: 0 },
    ];

    // The three options for logging how much the child ate
    const EATEN_OPTIONS = [
      { id: 'none', label: 'None', points: 0,  icon: 'ph-fill ph-x-circle',     color: 'text-accent',    bg: 'bg-red-50 border-red-200' },
      { id: 'some', label: 'Some', points: 5,  icon: 'ph-fill ph-minus-circle',  color: 'text-amber-500', bg: 'bg-amber-50 border-amber-200' },
      { id: 'all',  label: 'All',  points: 10, icon: 'ph-fill ph-check-circle',  color: 'text-brand-500', bg: 'bg-brand-50 border-brand-200' },
    ];

    const STOCK_OPTIONS = [
      { id: 'in', label: 'In', icon: 'ph-bold ph-check-circle', color: 'text-brand-500' },
      { id: 'low', label: 'Low', icon: 'ph-bold ph-warning-diamond', color: 'text-neutral' },
      { id: 'out', label: 'Out', icon: 'ph-bold ph-prohibit', color: 'text-accent' },
    ];
    const MEALS = ['breakfast', 'lunch', 'dinner', 'snack'];
    const DAY_LABELS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    // --- Preference Score Helpers ---

    // Compute a preference score for a food based on its serving history.
    // Returns { score, ratingId, rating } where rating is the full RATINGS object.
    // If no servings exist, score is null and rating is null.
    const getPreferenceScore = (foodId, servings) => {
      // Calculate the date 6 months ago for filtering
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      const cutoff = sixMonthsAgo.toLocaleDateString('en-CA');

      // Get all servings for this food within the last 6 months
      const recent = (servings || []).filter(
        s => s.foodId === foodId && s.date >= cutoff
      );

      // No data = no score
      if (recent.length === 0) return { score: null, ratingId: null, rating: null };

      // Map each serving to its point value and compute the average
      const pointMap = { none: 0, some: 5, all: 10 };
      const total = recent.reduce((sum, s) => sum + (pointMap[s.eaten] ?? 0), 0);
      const score = total / recent.length;

      // Find which rating tier the score falls into (loves > likes > meh > dislikes)
      const r = RATINGS.find(rt => score >= rt.min);
      return { score, ratingId: r?.id || null, rating: r || null };
    };

    // Get the last N servings for a food, sorted most-recent-first
    const getRecentServings = (foodId, servings, count = 5) => {
      return (servings || [])
        .filter(s => s.foodId === foodId)
        .sort((a, b) => b.date.localeCompare(a.date) || b.id.localeCompare(a.id))
        .slice(0, count);
    };

    // --- Reducer ---
    const appReducer = (state, action) => {
      switch (action.type) {
        case 'HYDRATE': return { ...state, ...action.payload, isLoaded: true };

        case 'ADD_FOOD': {
          const name = action.name.trim();
          const mem = state.foodMemory?.[name.toLowerCase()] || {};
          // Food objects no longer carry a .rating field ‚Äî preferences are computed from servings
          const food = {
            id: generateId(), name,
            categories: action.categories || mem.categories || [],
            stock: action.stock || 'in',
            notes: action.notes || mem.notes || '',
            source: action.source || 'home',
            createdAt: getTodayStr()
          };
          return { ...state, foods: [...state.foods, food] };
        }

        case 'BATCH_ADD': {
          let updatedFoods = [...state.foods];
          action.names.forEach(n => {
            const clean = n.trim();
            if (!clean || updatedFoods.some(f => f.name.toLowerCase() === clean.toLowerCase())) return;
            const mem = state.foodMemory?.[clean.toLowerCase()] || {};
            updatedFoods.push({
              id: generateId(), name: clean,
              categories: mem.categories || [],
              stock: 'in', notes: mem.notes || '',
              source: 'home', createdAt: getTodayStr()
            });
          });
          return { ...state, foods: updatedFoods };
        }

        case 'UPDATE_FOOD': {
          const foods = state.foods.map(f => f.id === action.id ? { ...f, ...action.updates } : f);
          const food = foods.find(f => f.id === action.id);
          if (!food) return state;
          // foodMemory stores categories and notes (no longer rating)
          const memory = { ...state.foodMemory, [food.name.toLowerCase()]: { categories: food.categories, notes: food.notes } };
          return { ...state, foods, foodMemory: memory };
        }

        case 'BULK_UPDATE': {
          const updatedFoods = state.foods.map(f => action.ids.includes(f.id) ? { ...f, ...action.updates } : f);
          return { ...state, foods: updatedFoods };
        }

        case 'DELETE_FOODS': return { ...state, foods: state.foods.filter(f => !action.ids.includes(f.id)) };

        case 'TOGGLE_FOOD_IN_MEAL': {
          const plan = state.plans.find(p => p.date === action.date && p.meal === action.meal);
          if (!plan?.foodIds.includes(action.foodId)) {
            if (plan) return { ...state, plans: state.plans.map(p => p.id === plan.id ? { ...p, foodIds: [...p.foodIds, action.foodId] } : p) };
            return { ...state, plans: [...state.plans, { id: generateId(), date: action.date, meal: action.meal, foodIds: [action.foodId] }] };
          }
          return { ...state, plans: state.plans.map(p => (p.date === action.date && p.meal === action.meal) ? { ...p, foodIds: p.foodIds.filter(id => id !== action.foodId) } : p).filter(p => p.foodIds.length > 0) };
        }

        // Restaurant discovery: creates the food AND logs an initial serving
        case 'DISCOVER_FOOD': {
          const name = action.name.trim();
          const foodId = generateId();
          const newFood = { id: foodId, name, categories: [], stock: 'out', notes: '', source: 'outside', createdAt: getTodayStr() };
          // Add to today's dinner plan
          const plan = state.plans.find(p => p.date === getTodayStr() && p.meal === 'dinner');
          const newPlans = plan
            ? state.plans.map(p => p.id === plan.id ? { ...p, foodIds: [...p.foodIds, foodId] } : p)
            : [...state.plans, { id: generateId(), date: getTodayStr(), meal: 'dinner', foodIds: [foodId] }];
          // Log the initial eating event if an eaten value was provided
          const newServings = action.eaten
            ? [...state.servings, { id: generateId(), foodId, date: getTodayStr(), meal: 'dinner', eaten: action.eaten }]
            : state.servings;
          return { ...state, foods: [...state.foods, newFood], plans: newPlans, servings: newServings };
        }

        case 'SAVE_COMBO': return { ...state, combos: [...state.combos, { id: generateId(), name: action.name, foodIds: action.foodIds }] };

        case 'APPLY_COMBO': {
          let s = state;
          action.foodIds.forEach(fid => { s = appReducer(s, { type: 'TOGGLE_FOOD_IN_MEAL', date: action.date, meal: action.meal, foodId: fid }); });
          return s;
        }

        case 'DISMISS_SHOPPING': return { ...state, shoppingDismissed: [...(state.shoppingDismissed || []), action.id] };
        case 'DELETE_FOOD': return { ...state, foods: state.foods.filter(f => f.id !== action.id) };

        // Log a single serving (e.g., from discovery modal)
        case 'LOG_SERVING': {
          return { ...state, servings: [...state.servings, { id: generateId(), foodId: action.foodId, date: action.date, meal: action.meal, eaten: action.eaten }] };
        }

        // Log a batch of servings at once (from the meal check-in flow)
        // action.entries is an array of { foodId, date, meal, eaten }
        case 'LOG_SERVINGS_BATCH': {
          const newServings = action.entries.map(e => ({ id: generateId(), ...e }));
          return { ...state, servings: [...state.servings, ...newServings] };
        }

        // Import replaces all data stores from an uploaded JSON backup
        case 'IMPORT_DATA': return {
          ...state,
          foods: action.payload.foods || [],
          plans: action.payload.plans || [],
          combos: action.payload.combos || [],
          foodMemory: action.payload.foodMemory || {},
          shoppingDismissed: action.payload.shoppingDismissed || [],
          servings: action.payload.servings || [],
        };

        default: return state;
      }
    };

    // --- Migration: convert old manual ratings to synthetic serving records ---
    // Called once after HYDRATE if foods still have .rating fields
    const migrateRatingsToServings = (foods, existingServings) => {
      const newServings = [];
      const updatedFoods = foods.map(f => {
        if (!f.rating) return f;
        // Map old rating to an eaten value
        const eatenMap = { loves: 'all', likes: 'some', neutral: 'some', dislikes: 'none' };
        const eaten = eatenMap[f.rating] || 'some';
        // Create a synthetic serving dated to when the food was created
        newServings.push({
          id: generateId(),
          foodId: f.id,
          date: f.createdAt || getTodayStr(),
          meal: 'lunch', // arbitrary ‚Äî just need a data point
          eaten,
        });
        // Strip the old rating field from the food
        const { rating, ...cleanFood } = f;
        return cleanFood;
      });
      return { foods: updatedFoods, servings: [...existingServings, ...newServings] };
    };

    // --- UI Helpers ---
    const Modal = ({ children, onClose }) => (
      <div className="fixed inset-0 z-[100] flex items-center justify-center bg-brand-900/60 p-4 animate-in" onClick={(e) => e.target === e.currentTarget && onClose()}>
        <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-md max-h-[85vh] overflow-y-auto">{children}</div>
      </div>
    );

    // RatingIcon: renders a preference icon based on computed score from servings.
    // Pass foodId + servings for computed mode, or ratingId for direct mode.
    const RatingIcon = ({ foodId, servings, ratingId, size = "sm" }) => {
      // If a direct ratingId is given, use it; otherwise compute from servings
      const id = ratingId || (foodId ? getPreferenceScore(foodId, servings).ratingId : null);
      const r = RATINGS.find(rt => rt.id === id);
      return r ? <i className={`${r.icon} ${r.color} ${size === 'lg' ? 'text-3xl' : 'text-xl'}`}></i> : null;
    };

    const calculateExposures = (foodId, plans) => plans.filter(p => p.date <= getTodayStr() && p.foodIds.includes(foodId)).length;

    // ==========================================================================
    // MAIN VIEWS
    // ==========================================================================

    function TodayView({ foods, plans, servings, state, dispatch, setQuickSort }) {
      const [checkInMeal, setCheckInMeal] = useState(null); // which meal to check in
      const [restaurantMode, setRestaurantMode] = useState(false);
      const [showData, setShowData] = useState(false);
      const tStr = getTodayStr();

      // Find meals that have planned foods but no servings logged yet today.
      // These are the meals that need a check-in.
      const uncheckedMeals = useMemo(() => {
        return MEALS.filter(meal => {
          const plan = plans.find(p => p.date === tStr && p.meal === meal);
          if (!plan || plan.foodIds.length === 0) return false;
          // Check if ANY food in this meal already has a serving logged for today
          const hasServings = plan.foodIds.some(fid =>
            servings.some(s => s.foodId === fid && s.date === tStr && s.meal === meal)
          );
          return !hasServings;
        });
      }, [plans, servings, tStr]);

      const streak = useMemo(() => {
        let count = 0; let d = new Date();
        while (true) {
          const dStr = d.toLocaleDateString('en-CA');
          const dayPlans = plans.filter(p => p.date === dStr && p.meal !== 'snack');
          if (dayPlans.length === 0) break;
          const covered = new Set();
          dayPlans.forEach(p => p.foodIds.forEach(fid => foods.find(f => f.id === fid)?.categories?.forEach(c => covered.add(c))));
          if (BALANCE_CATEGORIES.every(c => covered.has(c))) { count++; d.setDate(d.getDate() - 1); } else break;
        }
        return count;
      }, [plans, foods]);

      // Helper to check if a food is "disliked" via computed score
      const isDisliked = (f) => {
        const { ratingId } = getPreferenceScore(f.id, servings);
        return ratingId === 'dislikes';
      };

      return (
        <div className="animate-in pb-24">
          <div className="bg-brand-500 rounded-[2.5rem] p-8 text-white shadow-xl mb-6 relative overflow-hidden">
            <h2 className="text-5xl font-black mb-1">{streak} Days</h2>
            <p className="text-brand-100 font-bold uppercase tracking-widest text-[10px] opacity-80">Balanced Streak</p>
            <div className="absolute top-6 right-6 flex gap-2">
              <button onClick={() => setShowData(true)} className="w-10 h-10 bg-brand-900/60 rounded-full flex items-center justify-center shadow-lg active:scale-90"><i className="ph ph-gear"></i></button>
              <button onClick={() => setQuickSort(true)} className="w-10 h-10 bg-brand-900 rounded-full flex items-center justify-center shadow-lg active:scale-90"><i className="ph ph-lightning-fill"></i></button>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-4 mb-6">
            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
              <p className="text-3xl font-black text-brand-500">{foods.filter(f => calculateExposures(f.id, plans) >= 15).length}</p>
              <p className="text-[10px] font-bold text-neutral uppercase tracking-tighter">Accepted Foods</p>
            </div>
            <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
              <p className="text-3xl font-black text-accent">{foods.filter(f => f.stock !== 'in' && !isDisliked(f) && f.source !== 'outside').length}</p>
              <p className="text-[10px] font-bold text-neutral uppercase tracking-tighter">Shopping Items</p>
            </div>
          </div>
          <div className="space-y-3">
            <button onClick={() => setRestaurantMode(true)} className="w-full bg-white border border-brand-100 p-6 rounded-[2rem] shadow-sm flex items-center justify-between active:scale-95 transition-all">
              <div className="text-left">
                <p className="text-lg font-black text-brand-900">Dining Out?</p>
                <p className="text-xs text-neutral font-bold opacity-60">Log a restaurant discovery</p>
              </div>
              <i className="ph ph-plus-circle text-brand-500 text-2xl"></i>
            </button>
            {/* Per-meal check-in buttons ‚Äî one for each meal that needs logging */}
            {uncheckedMeals.map(meal => (
              <button key={meal} onClick={() => setCheckInMeal(meal)}
                className="w-full bg-brand-900 text-white p-7 rounded-[2.5rem] shadow-xl flex items-center justify-between active:scale-95 transition-all">
                <div className="text-left">
                  <p className="text-xl font-black text-white capitalize">How was {meal}?</p>
                  <p className="text-xs opacity-60 font-bold uppercase tracking-widest mt-1">Log what was eaten</p>
                </div>
                <i className="ph ph-arrow-circle-right text-white text-2xl"></i>
              </button>
            ))}
          </div>
          {restaurantMode && <DiscoveryModal dispatch={dispatch} onClose={() => setRestaurantMode(false)} />}
          {checkInMeal && <MealCheckInModal meal={checkInMeal} plans={plans} foods={foods} servings={servings} dispatch={dispatch} onClose={() => setCheckInMeal(null)} />}
          {showData && <DataModal state={state} dispatch={dispatch} onClose={() => setShowData(false)} />}
        </div>
      );
    }

    function MealPlannerView({ foods, plans, combos, servings, dispatch }) {
      const [viewMode, setViewMode] = useState('daily');
      const [date, setDate] = useState(getTodayStr());
      const [picker, setPicker] = useState(null);
      const shift = (o) => { let d = new Date(date + 'T00:00:00'); d.setDate(d.getDate() + o); setDate(d.toLocaleDateString('en-CA')); };
      const weekDates = Array.from({length: 7}, (_, i) => { const d = new Date(date + 'T00:00:00'); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1) + i; d.setDate(diff); return d.toLocaleDateString('en-CA'); });

      return (
        <div className="animate-in pb-24 px-1">
          <div className="bg-white p-4 rounded-3xl border border-slate-100 mb-4 sticky top-0 z-30 shadow-sm"><div className="flex justify-between items-center mb-4"><button onClick={() => shift(-1)} className="w-10 h-10 bg-brand-50 text-brand-500 rounded-full font-black flex items-center justify-center active:scale-90"><i className="ph ph-caret-left"></i></button><div className="text-center font-black"><p className="text-lg text-brand-900">{date === getTodayStr() ? 'Today' : date.split('-').slice(1).join('/')}</p><p className="text-[8px] uppercase tracking-[0.3em] text-neutral">{new Date(date+'T00:00:00').toLocaleDateString('en-US',{weekday:'long'})}</p></div><button onClick={() => shift(1)} className="w-10 h-10 bg-brand-50 text-brand-500 rounded-full font-black flex items-center justify-center active:scale-90"><i className="ph ph-caret-right"></i></button></div><div className="flex gap-2 p-1 bg-brand-50 rounded-2xl"><button onClick={() => setViewMode('daily')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${viewMode === 'daily' ? 'bg-white shadow text-brand-500' : 'opacity-40'}`}>Daily</button><button onClick={() => setViewMode('weekly')} className={`flex-1 py-2 text-[10px] font-black uppercase rounded-xl transition-all ${viewMode === 'weekly' ? 'bg-white shadow text-brand-500' : 'opacity-40'}`}>Weekly</button></div></div>
          {viewMode === 'daily' ? (
            <div className="space-y-4">{MEALS.map(m => {
              const p = plans.find(plan => plan.date === date && plan.meal === m);
              const pf = p?.foodIds.map(id => foods.find(f => f.id === id)).filter(Boolean) || [];
              const cov = new Set(pf.flatMap(f => f.categories || []));
              return (<div key={m} onClick={() => setPicker({date, meal:m})} className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-transparent active:scale-[0.98] transition-all"><div className="flex justify-between items-center mb-4"><h3 className="font-black text-xl capitalize text-brand-900">{m}</h3><div className="flex gap-1">{BALANCE_CATEGORIES.map(c => (<span key={c} className={`text-[8px] px-1.5 py-0.5 rounded font-black ${cov.has(c) ? 'bg-brand-500 text-white' : 'bg-slate-100 text-slate-300'}`}>{c[0].toUpperCase()}</span>))}</div></div>{pf.length ? <div className="space-y-2">{pf.map(f => (<div key={f.id} className="flex justify-between items-center bg-brand-50/50 p-3 rounded-xl text-sm font-bold"><span>{f.name}</span><RatingIcon foodId={f.id} servings={servings} /></div>))}</div> : <p className="text-[10px] text-slate-200 border-2 border-dashed border-slate-100 rounded-2xl py-6 text-center font-black uppercase tracking-widest">+ Add Food</p>}</div>);
            })}</div>
          ) : (
            <div className="bg-white rounded-[2rem] border overflow-hidden"><div className="overflow-x-auto no-scrollbar"><div className="min-w-[500px]">
              <div className="grid grid-cols-[60px_repeat(7,1fr)] bg-slate-50 border-b border-slate-100"><div />{weekDates.map((d, i) => (<div key={d} className={`py-3 text-center ${d === getTodayStr() ? 'bg-brand-500 text-white' : ''}`}><p className="text-[8px] font-black opacity-60">{DAY_LABELS[i]}</p><p className="text-xs font-black">{d.split('-')[2]}</p></div>))}</div>
              {MEALS.map(meal => (<div key={meal} className="grid grid-cols-[60px_repeat(7,1fr)] border-b last:border-0"><div className="flex items-center justify-center p-2 text-[10px] font-black uppercase opacity-20">{meal[0]}</div>{weekDates.map(d => { const p = plans.find(plan => plan.date === d && plan.meal === meal); const cov = new Set(p?.foodIds.flatMap(id => foods.find(f => f.id === id)?.categories || [])); return (<div key={d} onClick={() => { setDate(d); setViewMode('daily'); }} className={`p-2 border-l flex flex-col items-center justify-center gap-1 ${d === date ? 'bg-brand-50/30' : ''}`}><div className="flex flex-wrap gap-0.5 justify-center">{BALANCE_CATEGORIES.map(c => (<div key={c} className={`w-2 h-2 rounded-full ${cov.has(c) ? 'bg-brand-500' : 'bg-slate-100'}`} />))}</div></div>); })}</div>))}
            </div></div></div>
          )}
          {picker && <FoodPickerModal date={picker.date} meal={picker.meal} foods={foods} combos={combos} servings={servings} current={plans.find(p => p.date === picker.date && p.meal === picker.meal)?.foodIds || []} dispatch={dispatch} onClose={() => setPicker(null)} />}
        </div>
      );
    }

    function FoodPickerModal({ date, meal, foods, combos, servings, current, dispatch, onClose }) {
      const [tab, setTab] = useState('pantry');
      const [search, setSearch] = useState('');
      const [cat, setCat] = useState(null);
      const covered = useMemo(() => { const s = new Set(); current.forEach(id => foods.find(f=>f.id===id)?.categories?.forEach(c=>s.add(c))); return s; }, [current, foods]);
      const list = foods.filter(f => (tab === 'pantry' ? f.stock !== 'out' && f.source !== 'outside' : true) && f.name.toLowerCase().includes(search.toLowerCase()) && (!cat || f.categories?.includes(cat))).sort((a,b)=>a.name.localeCompare(b.name));
      return (
        <Modal onClose={onClose}><div className="p-6"><h2 className="text-2xl font-black mb-4 text-brand-900 tracking-tight capitalize">Add to {meal}</h2><input type="text" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-brand-50 p-4 rounded-2xl outline-none font-bold text-brand-900 mb-4" /><div className="flex gap-2 overflow-x-auto no-scrollbar pb-4"><button onClick={() => setCat(null)} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase ${!cat ? 'bg-brand-900 text-white' : 'bg-white border text-neutral'}`}>All</button>{CATEGORIES.map(c => (<button key={c.id} onClick={() => setCat(cat === c.id ? null : c.id)} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-1.5 ${cat === c.id ? 'bg-brand-900 text-white' : 'bg-white border text-neutral'}`}>{covered.has(c.id) && <div className="w-1.5 h-1.5 rounded-full bg-brand-500" />} {c.label}</button>))}</div><div className="flex gap-1 p-1 bg-gray-100 rounded-2xl mb-4">{['pantry', 'library', 'combos'].map(t => (<button key={t} onClick={() => setTab(t)} className={`flex-1 py-2 text-[10px] uppercase font-black rounded-xl ${tab === t ? 'bg-white shadow text-brand-900' : 'text-gray-400'}`}>{t}</button>))}</div><div className="space-y-2 max-h-64 overflow-y-auto no-scrollbar">{tab === 'combos' ? (combos || []).map(c => (<button key={c.id} onClick={() => { dispatch({type:'APPLY_COMBO', date, meal, foodIds:c.foodIds}); onClose(); }} className="w-full p-4 bg-brand-50 rounded-2xl text-left border border-brand-100 active:scale-95 shadow-sm"><p className="font-black text-brand-900">{c.name}</p><p className="text-[10px] font-bold text-neutral uppercase mt-1 opacity-60">{c.foodIds.length} items</p></button>)) : list.map(f => { const sel = current.includes(f.id); return (<button key={f.id} onClick={() => dispatch({type:'TOGGLE_FOOD_IN_MEAL', date, meal, foodId:f.id})} className={`w-full p-4 rounded-2xl border flex justify-between items-center transition-all active:scale-95 ${sel ? 'bg-brand-100 border-brand-500 text-brand-900 shadow-inner' : 'bg-white border-slate-100'}`}><span className="font-bold">{f.name}</span><RatingIcon foodId={f.id} servings={servings} /></button>); })}</div><button onClick={onClose} className="w-full mt-6 py-5 bg-brand-900 text-white rounded-3xl font-black uppercase shadow-xl">Done</button></div></Modal>
      );
    }

    function ListView({ foods, plans, servings, title, selectionIds, setSelectionIds, onEdit, dispatch, showBatch }) {
      const [search, setSearch] = useState('');
      const [batchMode, setBatchMode] = useState(false);
      const [input, setInput] = useState('');
      const filtered = foods.filter(f => f.name.toLowerCase().includes(search.toLowerCase())).sort((a,b) => a.name.localeCompare(b.name));
      const inSelect = selectionIds.length > 0;
      return (
        <div className="animate-in pb-40 space-y-1.5"><div className="flex justify-between items-center mb-6 px-1"><h2 className="text-3xl font-black text-brand-900 tracking-tight">{title}</h2><div className="flex gap-2">{showBatch && <button onClick={() => setBatchMode(true)} className="bg-brand-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg">Batch</button>}<button onClick={() => setSelectionIds(inSelect ? [] : [filtered[0]?.id].filter(Boolean))} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase ${inSelect ? 'bg-brand-900 text-white' : 'bg-white border text-brand-500'}`}>{inSelect ? 'Cancel' : 'Select'}</button></div></div><input type="text" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} className="w-full p-3 mb-4 rounded-2xl bg-white shadow-sm border-none font-bold text-sm outline-none" />{filtered.map(f => { const sel = selectionIds.includes(f.id); return (<div key={f.id} onClick={() => inSelect ? setSelectionIds(p => p.includes(f.id) ? p.filter(x => x !== f.id) : [...p, f.id]) : onEdit(f)} className={`food-card bg-white px-4 py-2.5 rounded-xl border border-transparent shadow-sm flex justify-between items-center ${sel ? 'selected-card border-brand-500 scale-[0.98]' : 'border-b-slate-100'}`}><div className="flex items-center gap-3">{inSelect && <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${sel ? 'bg-brand-500 border-brand-500' : 'bg-white border-slate-200'}`}>{sel && <i className="ph ph-check text-[10px] text-white"></i>}</div>}<div><p className="font-bold text-sm">{f.source === 'outside' && 'üçΩÔ∏è '}{f.name}</p><div className="flex gap-1 mt-0.5"><p className="text-[8px] uppercase font-black text-neutral opacity-50 tracking-tighter">Tries: {calculateExposures(f.id, plans)}</p>{f.stock === 'low' && <span className="text-[8px] font-black text-amber-500 ml-1">Low</span>}</div></div></div><RatingIcon foodId={f.id} servings={servings} /></div>); })}{batchMode && <Modal onClose={() => setBatchMode(false)}><div className="p-8"><h2 className="text-2xl font-black mb-4">Batch Import</h2><textarea value={input} onChange={e => setInput(e.target.value)} className="w-full h-40 bg-brand-50 rounded-2xl p-4 outline-none border-none font-bold" placeholder="Pizza, Peas, Pasta..." /><div className="flex gap-2 mt-6"><button onClick={() => setBatchMode(false)} className="flex-1 font-bold text-neutral uppercase text-[10px]">Cancel</button><button onClick={() => { dispatch({type:'BATCH_ADD', names: input.split(/[,\n]/)}); setBatchMode(false); setInput(''); }} className="flex-[2] bg-brand-500 text-white py-4 rounded-2xl font-black shadow-lg">Import</button></div></div></Modal>}<BulkActionBar selectedIds={selectionIds} onClear={() => setSelectionIds([])} dispatch={dispatch} /></div>
      );
    }

    // --- Core UI ---
    function App() {
      const [state, dispatch] = useReducer(appReducer, {
        isLoaded: false, foods: [], plans: [], combos: [],
        shoppingDismissed: [], foodMemory: {}, servings: []
      });
      const [tab, setTab] = useState('today');
      const [edit, setEdit] = useState(null);
      const [pSelect, setPSelect] = useState([]);
      const [lSelect, setLSelect] = useState([]);
      const [quickSort, setQuickSort] = useState(false);

      useEffect(() => {
        const load = async () => {
          const foods = await dbLoad('foods', []);
          const plans = await dbLoad('plans', []);
          const memory = await dbLoad('memory', {});
          const dismissed = await dbLoad('dismissed', []);
          const combos = await dbLoad('combos', []);
          const servings = await dbLoad('servings', []);

          // --- Migration: convert old manual .rating fields to serving records ---
          const hasOldRatings = foods.some(f => f.rating);
          if (hasOldRatings) {
            const migrated = migrateRatingsToServings(foods, servings);
            // Also clean rating out of foodMemory entries
            const cleanMemory = {};
            Object.entries(memory).forEach(([k, v]) => {
              const { rating, ...rest } = v || {};
              cleanMemory[k] = rest;
            });
            dispatch({ type: 'HYDRATE', payload: {
              foods: migrated.foods, plans, foodMemory: cleanMemory,
              shoppingDismissed: dismissed, combos, servings: migrated.servings
            }});
          } else {
            dispatch({ type: 'HYDRATE', payload: {
              foods, plans, foodMemory: memory,
              shoppingDismissed: dismissed, combos, servings
            }});
          }
        };
        load();
      }, []);

      useEffect(() => {
        if (!state.isLoaded) return;
        dbSave('foods', state.foods);
        dbSave('plans', state.plans);
        dbSave('memory', state.foodMemory);
        dbSave('dismissed', state.shoppingDismissed);
        dbSave('combos', state.combos);
        dbSave('servings', state.servings);
      }, [state]);

      if (!state.isLoaded) return <div className="flex h-screen items-center justify-center text-brand-500 font-black animate-pulse uppercase">Loading</div>;

      const NAV = [ {id:'today', i:'ph-house'}, {id:'pantry', i:'ph-package'}, {id:'library', i:'ph-books'}, {id:'planner', i:'ph-calendar-blank'}, {id:'shopping', i:'ph-shopping-cart'} ];

      if (quickSort) return <div className="min-h-screen bg-brand-50"><QuickSortView foods={state.foods} dispatch={dispatch} onClose={() => setQuickSort(false)} /></div>;

      return (
        <div className="min-h-screen flex flex-col pt-8">
          <main className="flex-1 max-w-md mx-auto w-full p-6">
            {tab === 'today' && <TodayView foods={state.foods} plans={state.plans} servings={state.servings} state={state} dispatch={dispatch} setQuickSort={setQuickSort} />}
            {tab === 'pantry' && <ListView foods={state.foods.filter(f => f.stock !== 'out' && f.source !== 'outside')} plans={state.plans} servings={state.servings} title="Pantry" selectionIds={pSelect} setSelectionIds={setPSelect} onEdit={setEdit} dispatch={dispatch} />}
            {tab === 'library' && <ListView foods={state.foods} plans={state.plans} servings={state.servings} title="Library" selectionIds={lSelect} setSelectionIds={setLSelect} onEdit={setEdit} dispatch={dispatch} showBatch />}
            {tab === 'planner' && <MealPlannerView foods={state.foods} plans={state.plans} combos={state.combos} servings={state.servings} dispatch={dispatch} />}
            {tab === 'shopping' && <ShoppingListView foods={state.foods} plans={state.plans} servings={state.servings} dismissed={state.shoppingDismissed} dispatch={dispatch} />}
          </main>
          <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around p-3 pb-8 z-50">{NAV.map(t => (<button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center gap-1 transition-all ${tab === t.id ? 'scale-110 text-brand-500' : 'opacity-40 grayscale'}`}><i className={`${tab === t.id ? t.i + '-fill' : t.i} text-2xl`}></i><span className="text-[9px] font-black uppercase tracking-widest">{t.id}</span></button>))}</nav>
          {edit && <FoodFormModal food={edit} plans={state.plans} servings={state.servings} onSave={(d) => { dispatch({type:'UPDATE_FOOD', id:edit.id, updates:d}); setEdit(null); }} onDelete={() => { dispatch({type:'DELETE_FOOD', id:edit.id}); setEdit(null); }} onClose={() => setEdit(null)} />}
        </div>
      );
    }

    // ==========================================================================
    // COMPONENTS
    // ==========================================================================

    // FoodFormModal: Edit a single food's details. Now shows computed preference
    // score and last 5 servings instead of a manual rating selector.
    function FoodFormModal({ food, plans, servings, onSave, onDelete, onClose }) {
      const [cats, setCats] = useState(food.categories || []);
      const [stock, setStock] = useState(food.stock || 'in');
      const [notes, setNotes] = useState(food.notes || '');
      const [confirmDelete, setConfirmDelete] = useState(false);
      const exposures = calculateExposures(food.id, plans);
      const progress = Math.min(exposures / 15, 1);

      // Compute the current preference score
      const pref = getPreferenceScore(food.id, servings);
      // Get the last 5 servings for the history timeline
      const recentServings = getRecentServings(food.id, servings, 5);

      return (
        <Modal onClose={onClose}>
          <div className="p-8">
            {/* Header with food name and source badge */}
            <h2 className="text-2xl font-black text-brand-900 mb-1">{food.name}</h2>
            {food.source === 'outside' && (
              <p className="text-[10px] font-bold text-neutral uppercase tracking-widest mb-4">Restaurant Discovery</p>
            )}

            {/* Computed preference score display */}
            {pref.rating ? (
              <div className="flex items-center gap-3 mb-4 mt-2 bg-brand-50 p-4 rounded-2xl">
                <RatingIcon ratingId={pref.ratingId} size="lg" />
                <div>
                  <p className="font-black text-brand-900">{pref.rating.label}</p>
                  <p className="text-[10px] font-bold text-neutral">Score: {pref.score.toFixed(1)} / 10</p>
                </div>
              </div>
            ) : (
              <div className="mb-4 mt-2 bg-slate-50 p-4 rounded-2xl text-center">
                <p className="text-[10px] font-black text-neutral uppercase tracking-widest">No preference data yet</p>
              </div>
            )}

            {/* Last 5 servings timeline */}
            {recentServings.length > 0 && (
              <div className="mb-6">
                <p className="text-[10px] font-black uppercase text-neutral tracking-widest mb-2">Recent Servings</p>
                <div className="space-y-1.5">
                  {recentServings.map(s => {
                    const opt = EATEN_OPTIONS.find(e => e.id === s.eaten);
                    return (
                      <div key={s.id} className={`flex items-center justify-between p-3 rounded-xl border ${opt?.bg || 'bg-white border-slate-100'}`}>
                        <div className="flex items-center gap-2">
                          <i className={`${opt?.icon} ${opt?.color} text-lg`}></i>
                          <span className="text-xs font-bold capitalize">{opt?.label || s.eaten}</span>
                        </div>
                        <div className="text-right">
                          <p className="text-[10px] font-bold text-neutral">{s.date.split('-').slice(1).join('/')}</p>
                          <p className="text-[8px] font-black uppercase text-neutral opacity-50">{s.meal}</p>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Exposure progress bar */}
            <div className="mb-6">
              <div className="flex justify-between items-center mb-1">
                <p className="text-[10px] font-black uppercase text-neutral tracking-widest">Exposure Progress</p>
                <p className="text-[10px] font-black text-brand-500">{exposures}/15</p>
              </div>
              <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                <div className="h-full bg-accent rounded-full transition-all" style={{ width: `${progress * 100}%` }} />
              </div>
            </div>

            {/* Category toggles */}
            <p className="text-[10px] font-black uppercase text-neutral tracking-widest mb-2">Categories</p>
            <div className="flex flex-wrap gap-2 mb-6">
              {CATEGORIES.map(c => {
                const active = cats.includes(c.id);
                return (
                  <button key={c.id}
                    onClick={() => setCats(prev => active ? prev.filter(x => x !== c.id) : [...prev, c.id])}
                    className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase border transition-all ${active ? 'bg-brand-500 text-white border-brand-500' : 'bg-white text-neutral border-slate-200'}`}
                  >{c.label}</button>
                );
              })}
            </div>

            {/* Stock status selector */}
            <p className="text-[10px] font-black uppercase text-neutral tracking-widest mb-2">Stock</p>
            <div className="flex gap-2 mb-6">
              {STOCK_OPTIONS.map(s => (
                <button key={s.id}
                  onClick={() => setStock(s.id)}
                  className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase border transition-all flex items-center justify-center gap-1.5 ${stock === s.id ? 'bg-brand-100 border-brand-500 text-brand-900' : 'bg-white border-slate-200 text-neutral'}`}
                ><i className={`${s.icon} ${s.color}`}></i> {s.label}</button>
              ))}
            </div>

            {/* Notes field */}
            <textarea value={notes} onChange={e => setNotes(e.target.value)}
              placeholder="Notes..." rows={2}
              className="w-full p-4 bg-brand-50 rounded-2xl outline-none font-bold text-sm mb-6" />

            {/* Action buttons ‚Äî no longer saves a rating */}
            <button onClick={() => onSave({ categories: cats, stock, notes })}
              className="w-full bg-brand-500 text-white py-5 rounded-3xl font-black uppercase shadow-xl mb-3">Save Changes</button>

            {/* Delete with confirmation guard */}
            {!confirmDelete ? (
              <button onClick={() => setConfirmDelete(true)}
                className="w-full py-3 text-accent text-[10px] font-black uppercase">Delete Food</button>
            ) : (
              <div className="flex gap-2">
                <button onClick={() => setConfirmDelete(false)}
                  className="flex-1 py-3 text-neutral text-[10px] font-black uppercase">Cancel</button>
                <button onClick={onDelete}
                  className="flex-1 py-3 bg-accent text-white rounded-2xl text-[10px] font-black uppercase">Confirm Delete</button>
              </div>
            )}
          </div>
        </Modal>
      );
    }

    // BulkActionBar: Floating toolbar that appears when foods are selected
    // in Pantry/Library. Lets you bulk-update stock or delete selected items.
    function BulkActionBar({ selectedIds, onClear, dispatch }) {
      const [confirmDelete, setConfirmDelete] = useState(false);
      if (selectedIds.length === 0) return null;

      return (
        <div className="fixed bottom-24 left-0 right-0 z-40 flex justify-center animate-in">
          <div className="bg-brand-900 text-white rounded-3xl shadow-2xl px-6 py-4 flex items-center gap-3 max-w-sm mx-4">
            <span className="text-[10px] font-black uppercase tracking-widest opacity-60">
              {selectedIds.length} selected
            </span>
            <div className="w-px h-6 bg-white/20" />
            {STOCK_OPTIONS.map(s => (
              <button key={s.id}
                onClick={() => { dispatch({ type: 'BULK_UPDATE', ids: selectedIds, updates: { stock: s.id } }); onClear(); }}
                className="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center active:scale-90"
                title={`Mark ${s.label}`}
              ><i className={`${s.icon} text-white text-sm`}></i></button>
            ))}
            <div className="w-px h-6 bg-white/20" />
            {!confirmDelete ? (
              <button onClick={() => setConfirmDelete(true)}
                className="w-9 h-9 rounded-full bg-accent/30 flex items-center justify-center active:scale-90">
                <i className="ph ph-trash text-accent text-sm"></i>
              </button>
            ) : (
              <button onClick={() => { dispatch({ type: 'DELETE_FOODS', ids: selectedIds }); onClear(); setConfirmDelete(false); }}
                className="px-4 py-2 bg-accent rounded-xl text-[10px] font-black uppercase active:scale-90">
                Delete {selectedIds.length}?
              </button>
            )}
          </div>
        </div>
      );
    }

    // QuickSortView: Card stack for rapidly categorizing foods.
    // Now only handles categories (ratings are computed from servings).
    function QuickSortView({ foods, dispatch, onClose }) {
      // Only queue foods that are missing categories
      const queue = useMemo(() =>
        foods.filter(f => (f.categories?.length === 0))
          .sort((a, b) => a.name.localeCompare(b.name)),
        [foods]
      );
      const [index, setIndex] = useState(0);
      const current = queue[index];
      const [cats, setCats] = useState([]);

      // Reset local state whenever we move to a new card
      useEffect(() => {
        if (current) {
          setCats(current.categories || []);
        }
      }, [index, current?.id]);

      // Save current card and advance to next
      const handleSave = () => {
        if (current) {
          dispatch({ type: 'UPDATE_FOOD', id: current.id, updates: { categories: cats } });
        }
        if (index < queue.length - 1) {
          setIndex(i => i + 1);
        } else {
          onClose();
        }
      };

      const handleSkip = () => {
        if (index < queue.length - 1) setIndex(i => i + 1);
        else onClose();
      };

      return (
        <div className="min-h-screen bg-brand-50 p-6 flex flex-col">
          <div className="flex justify-between items-center mb-6">
            <button onClick={onClose} className="text-[10px] font-black uppercase text-neutral">
              <i className="ph ph-x text-xl"></i>
            </button>
            <p className="text-[10px] font-black uppercase text-neutral tracking-widest">
              {queue.length === 0 ? 'All done!' : `${index + 1} of ${queue.length}`}
            </p>
            <div className="w-8" />
          </div>

          {queue.length === 0 || !current ? (
            <div className="flex-1 flex flex-col items-center justify-center text-center">
              <i className="ph ph-check-circle text-6xl text-brand-500 mb-4"></i>
              <p className="text-2xl font-black text-brand-900 mb-2">All Sorted!</p>
              <p className="text-sm text-neutral font-bold">Every food has categories.</p>
              <button onClick={onClose} className="mt-8 bg-brand-500 text-white px-8 py-4 rounded-3xl font-black uppercase shadow-lg">Done</button>
            </div>
          ) : (
            <div className="flex-1 flex flex-col">
              <div className="w-full h-1.5 bg-slate-200 rounded-full mb-8 overflow-hidden">
                <div className="h-full bg-brand-500 rounded-full transition-all" style={{ width: `${((index + 1) / queue.length) * 100}%` }} />
              </div>
              <div className="bg-white rounded-[2.5rem] p-8 shadow-xl flex-1 flex flex-col animate-in">
                <h2 className="text-3xl font-black text-brand-900 text-center mb-8">{current.name}</h2>
                <p className="text-[10px] font-black uppercase text-neutral tracking-widest mb-3">Categories</p>
                <div className="flex flex-wrap gap-2 mb-8">
                  {CATEGORIES.map(c => {
                    const active = cats.includes(c.id);
                    return (
                      <button key={c.id}
                        onClick={() => setCats(prev => active ? prev.filter(x => x !== c.id) : [...prev, c.id])}
                        className={`px-4 py-2.5 rounded-xl text-[10px] font-black uppercase border transition-all ${active ? 'bg-brand-500 text-white border-brand-500' : 'bg-white text-neutral border-slate-200'}`}
                      >{c.label}</button>
                    );
                  })}
                </div>
                <div className="mt-auto flex gap-3">
                  <button onClick={handleSkip}
                    className="flex-1 py-4 text-neutral font-black uppercase text-[10px] border border-slate-200 rounded-2xl">Skip</button>
                  <button onClick={handleSave}
                    className="flex-[2] py-4 bg-brand-500 text-white rounded-2xl font-black uppercase shadow-lg active:scale-95">
                    {index < queue.length - 1 ? 'Save & Next' : 'Save & Done'}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ShoppingListView: Generates a shopping list from foods that are low/out
    // of stock. Uses computed preference scores to exclude disliked foods.
    function ShoppingListView({ foods, plans, servings, dismissed, dispatch }) {
      const items = useMemo(() => {
        return foods
          .filter(f => {
            if (f.stock === 'in' || f.source === 'outside') return false;
            if ((dismissed || []).includes(f.id)) return false;
            // Exclude foods the child dislikes (computed from servings)
            const { ratingId } = getPreferenceScore(f.id, servings);
            return ratingId !== 'dislikes';
          })
          .sort((a, b) => a.name.localeCompare(b.name));
      }, [foods, dismissed, servings]);

      const grouped = useMemo(() => {
        const groups = {};
        items.forEach(f => {
          const cat = CATEGORIES.find(c => f.categories?.includes(c.id));
          const aisle = cat?.aisle || 'Other';
          if (!groups[aisle]) groups[aisle] = [];
          groups[aisle].push(f);
        });
        return groups;
      }, [items]);

      const aisleOrder = ['Produce', 'Meat/Dairy', 'Pantry', 'Snacks', 'Other'];

      const copyToClipboard = () => {
        const lines = aisleOrder
          .filter(a => grouped[a])
          .map(a => `${a}:\n${grouped[a].map(f => `  ${f.name}${f.stock === 'out' ? '' : ' (low)'}`).join('\n')}`)
          .join('\n\n');
        navigator.clipboard.writeText(lines);
      };

      const markAllStocked = () => {
        const ids = items.map(f => f.id);
        if (ids.length > 0) {
          dispatch({ type: 'BULK_UPDATE', ids, updates: { stock: 'in' } });
        }
      };

      return (
        <div className="animate-in pb-24">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-3xl font-black text-brand-900 tracking-tight">Shopping</h2>
            <div className="flex gap-2">
              <button onClick={copyToClipboard}
                className="bg-brand-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg flex items-center gap-1">
                <i className="ph ph-copy"></i> Copy
              </button>
            </div>
          </div>

          {items.length === 0 ? (
            <div className="text-center py-20">
              <i className="ph ph-check-circle text-5xl text-brand-500 mb-4"></i>
              <p className="text-xl font-black text-brand-900 mb-2">All Stocked!</p>
              <p className="text-sm text-neutral font-bold">Nothing to buy right now.</p>
            </div>
          ) : (
            <>
              {aisleOrder.filter(a => grouped[a]).map(aisle => (
                <div key={aisle} className="mb-6">
                  <p className="text-[10px] font-black uppercase text-neutral tracking-widest mb-2 px-1">{aisle}</p>
                  <div className="space-y-1.5">
                    {grouped[aisle].map(f => (
                      <div key={f.id} className="bg-white px-4 py-3 rounded-xl shadow-sm border border-slate-50 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                          <div className={`w-2.5 h-2.5 rounded-full ${f.stock === 'out' ? 'bg-accent' : 'bg-amber-400'}`} />
                          <span className="font-bold text-sm">{f.name}</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-[9px] font-black uppercase text-neutral opacity-50">
                            {f.stock === 'out' ? 'Out' : 'Low'}
                          </span>
                          <button onClick={() => dispatch({ type: 'DISMISS_SHOPPING', id: f.id })}
                            className="w-7 h-7 rounded-full bg-slate-50 flex items-center justify-center active:scale-90">
                            <i className="ph ph-x text-xs text-neutral"></i>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
              <button onClick={markAllStocked}
                className="w-full bg-brand-900 text-white py-5 rounded-3xl font-black uppercase shadow-xl mt-4">
                <i className="ph ph-check-circle mr-2"></i>Done Shopping ‚Äî Mark All Stocked
              </button>
            </>
          )}
        </div>
      );
    }

    // DataModal: Export/Import all data including servings
    function DataModal({ state, dispatch, onClose }) {
      const [importing, setImporting] = useState(false);
      const [importError, setImportError] = useState(null);
      const [importSuccess, setImportSuccess] = useState(false);
      const fileRef = useRef(null);

      const handleExport = () => {
        const exportData = {
          version: 3, // v3 includes servings
          exportedAt: new Date().toISOString(),
          foods: state.foods,
          plans: state.plans,
          combos: state.combos,
          foodMemory: state.foodMemory,
          shoppingDismissed: state.shoppingDismissed,
          servings: state.servings,
        };
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const dateStr = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `meal-tracker-backup-${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleImport = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        setImporting(true);
        setImportError(null);
        setImportSuccess(false);
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data = JSON.parse(evt.target.result);
            if (!data.foods || !Array.isArray(data.foods)) {
              throw new Error('Invalid backup file ‚Äî missing foods array.');
            }
            if (data.plans && !Array.isArray(data.plans)) {
              throw new Error('Invalid backup file ‚Äî plans is not an array.');
            }
            dispatch({ type: 'IMPORT_DATA', payload: data });
            setImportSuccess(true);
            setImporting(false);
          } catch (err) {
            setImportError(err.message || 'Failed to parse backup file.');
            setImporting(false);
          }
        };
        reader.onerror = () => {
          setImportError('Could not read the file.');
          setImporting(false);
        };
        reader.readAsText(file);
      };

      return (
        <Modal onClose={onClose}>
          <div className="p-8">
            <h2 className="text-2xl font-black text-brand-900 mb-1">Your Data</h2>
            <p className="text-[10px] font-black text-neutral uppercase tracking-widest mb-6">Export & Import</p>
            <div className="bg-brand-50 rounded-2xl p-5 mb-6">
              <div className="grid grid-cols-3 gap-3 text-center">
                <div>
                  <p className="text-2xl font-black text-brand-500">{state.foods.length}</p>
                  <p className="text-[8px] font-black text-neutral uppercase">Foods</p>
                </div>
                <div>
                  <p className="text-2xl font-black text-brand-500">{state.plans.length}</p>
                  <p className="text-[8px] font-black text-neutral uppercase">Meal Plans</p>
                </div>
                <div>
                  <p className="text-2xl font-black text-brand-500">{state.servings.length}</p>
                  <p className="text-[8px] font-black text-neutral uppercase">Servings</p>
                </div>
              </div>
            </div>
            <button onClick={handleExport}
              className="w-full bg-brand-500 text-white py-5 rounded-3xl font-black uppercase shadow-xl mb-3 flex items-center justify-center gap-2 active:scale-95 transition-all">
              <i className="ph ph-download-simple text-lg"></i> Export Backup
            </button>
            <p className="text-[10px] text-neutral text-center mb-6 font-bold opacity-60">Downloads a JSON file with all your data</p>
            <div className="border-t border-slate-100 pt-6">
              <button onClick={() => fileRef.current?.click()} disabled={importing}
                className="w-full bg-white border-2 border-dashed border-brand-500 text-brand-500 py-5 rounded-3xl font-black uppercase mb-3 flex items-center justify-center gap-2 active:scale-95 transition-all">
                <i className="ph ph-upload-simple text-lg"></i>
                {importing ? 'Importing...' : 'Import Backup'}
              </button>
              <input ref={fileRef} type="file" accept=".json" onChange={handleImport} className="hidden" />
              <p className="text-[10px] text-neutral text-center font-bold opacity-60">Replaces all current data with the backup</p>
              {importError && (
                <div className="mt-4 bg-red-50 text-red-600 p-4 rounded-2xl text-xs font-bold text-center">
                  <i className="ph ph-warning-circle mr-1"></i> {importError}
                </div>
              )}
              {importSuccess && (
                <div className="mt-4 bg-green-50 text-green-600 p-4 rounded-2xl text-xs font-bold text-center">
                  <i className="ph ph-check-circle mr-1"></i> Data imported successfully!
                </div>
              )}
            </div>
            <button onClick={onClose} className="w-full mt-6 py-3 text-neutral text-[10px] font-black uppercase">Close</button>
          </div>
        </Modal>
      );
    }

    // MealCheckInModal: Per-meal check-in flow. Shows each food from a specific
    // meal and lets the user tap None / Some / All for each one.
    function MealCheckInModal({ meal, plans, foods, servings, dispatch, onClose }) {
      const tStr = getTodayStr();
      const plan = plans.find(p => p.date === tStr && p.meal === meal);
      const mealFoods = (plan?.foodIds || []).map(id => foods.find(f => f.id === id)).filter(Boolean);

      // Track the user's selections: { foodId: 'none'|'some'|'all' }
      const [selections, setSelections] = useState({});
      // How many foods have been logged so far
      const loggedCount = Object.keys(selections).length;
      const allDone = loggedCount === mealFoods.length;

      const handleSelect = (foodId, eaten) => {
        setSelections(prev => ({ ...prev, [foodId]: eaten }));
      };

      // Save all selections as serving records
      const handleSave = () => {
        const entries = Object.entries(selections).map(([foodId, eaten]) => ({
          foodId, date: tStr, meal, eaten
        }));
        if (entries.length > 0) {
          dispatch({ type: 'LOG_SERVINGS_BATCH', entries });
        }
        onClose();
      };

      return (
        <Modal onClose={onClose}>
          <div className="p-8">
            <h2 className="text-2xl font-black text-brand-900 mb-1 capitalize">How was {meal}?</h2>
            <p className="text-[10px] font-black text-neutral uppercase tracking-widest mb-6">
              {loggedCount} of {mealFoods.length} logged
            </p>

            <div className="space-y-4">
              {mealFoods.map(f => {
                const selected = selections[f.id];
                return (
                  <div key={f.id} className="bg-brand-50 rounded-2xl p-5 border border-brand-100">
                    <p className="font-black text-brand-900 mb-3">{f.name}</p>
                    <div className="flex gap-2">
                      {EATEN_OPTIONS.map(opt => {
                        const isSelected = selected === opt.id;
                        return (
                          <button key={opt.id}
                            onClick={() => handleSelect(f.id, opt.id)}
                            className={`flex-1 py-3 rounded-xl border-2 flex flex-col items-center gap-1 transition-all active:scale-95 ${
                              isSelected
                                ? `${opt.bg} border-current ring-1 ring-current scale-[1.02]`
                                : 'bg-white border-slate-200 opacity-40'
                            }`}
                          >
                            <i className={`${opt.icon} ${opt.color} text-2xl`}></i>
                            <span className="text-[9px] font-black uppercase">{opt.label}</span>
                          </button>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>

            <button onClick={handleSave}
              disabled={!allDone}
              className={`w-full mt-6 py-5 rounded-3xl font-black uppercase shadow-xl transition-all ${
                allDone
                  ? 'bg-brand-500 text-white active:scale-95'
                  : 'bg-slate-200 text-slate-400 cursor-not-allowed'
              }`}>
              {allDone ? 'Save' : `${mealFoods.length - loggedCount} remaining`}
            </button>
            <button onClick={onClose} className="w-full mt-3 py-3 text-neutral text-[10px] font-black uppercase">
              Finish Later
            </button>
          </div>
        </Modal>
      );
    }

    // DiscoveryModal: Log a restaurant discovery with an initial eating rating
    function DiscoveryModal({ dispatch, onClose }) {
      const [name, setName] = useState('');
      const [eaten, setEaten] = useState(null);

      const handleSave = () => {
        if (!name.trim()) return;
        dispatch({ type: 'DISCOVER_FOOD', name, eaten });
        onClose();
      };

      return (
        <Modal onClose={onClose}>
          <div className="p-8">
            <h2 className="text-2xl font-black mb-1">Discovery</h2>
            <p className="text-[10px] font-black text-neutral uppercase tracking-widest mb-6">Log a new restaurant find</p>
            <div className="space-y-6">
              <input autoFocus type="text" value={name} onChange={e => setName(e.target.value)}
                placeholder="Food Name..."
                className="w-full p-4 bg-brand-50 rounded-2xl outline-none font-bold" />

              {/* How much did they eat? */}
              <div>
                <p className="text-[10px] font-black uppercase text-neutral tracking-widest mb-2">How much was eaten?</p>
                <div className="flex gap-2">
                  {EATEN_OPTIONS.map(opt => {
                    const isSelected = eaten === opt.id;
                    return (
                      <button key={opt.id}
                        onClick={() => setEaten(isSelected ? null : opt.id)}
                        className={`flex-1 py-4 rounded-xl border-2 flex flex-col items-center gap-1 transition-all ${
                          isSelected
                            ? `${opt.bg} border-current`
                            : 'bg-white border-slate-200 opacity-30'
                        }`}
                      >
                        <i className={`${opt.icon} ${opt.color} text-3xl`}></i>
                        <span className="text-[8px] font-black uppercase">{opt.label}</span>
                      </button>
                    );
                  })}
                </div>
              </div>

              <button onClick={handleSave}
                className="w-full bg-brand-500 text-white p-5 rounded-3xl font-black shadow-lg uppercase">
                Add to dinner
              </button>
            </div>
          </div>
        </Modal>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
