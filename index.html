<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Meal Tracker Sync</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/meal-tracker/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#167188" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCWPs2eVMJSCzG3f0YLMjL_PCT7ozYnCjM",
      authDomain: "cd-meal-tracker.firebaseapp.com",
      projectId: "cd-meal-tracker",
      storageBucket: "cd-meal-tracker.firebasestorage.app",
      messagingSenderId: "263676843677",
      appId: "1:263676843677:web:532e95fb0b879e9e67e674",
      measurementId: "G-R3DVDM36Z5"
    };

    window.FirebaseLib = { initializeApp, getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, writeBatch, getAuth, signInAnonymously, deleteDoc };
  </script>

  <script>
    tailwind.config = {
      theme: { extend: { colors: {
        brand: { 50: '#f0f7f9', 100: '#daebf1', 500: '#167188', 900: '#0D4250' },
        accent: '#FF6B6B', neutral: '#7E7F7F'
      } } }
    }
  </script>
  <style>
    body { padding-bottom: env(safe-area-inset-bottom); background: #f0f7f9; -webkit-tap-highlight-color: transparent; }
    html { overscroll-behavior: none; }
    button, nav { -webkit-user-select: none; user-select: none; }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .food-card { transition: all 0.1s ease; border-width: 2px; }
    .food-card:active { transform: scale(0.98); }
    .selected-card { border-color: #167188 !important; background-color: #daebf1 !important; }
  </style>
</head>
<body class="text-slate-800 tracking-tight">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useReducer, useCallback, useMemo, useRef } = React;

    // --- CONSTANTS ---
    const generateId = () => Math.random().toString(36).substring(2, 15);
    const getTodayStr = () => new Date().toLocaleDateString('en-CA');
    const generateFamilyCode = () => {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      return Array.from({length: 6}, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
    };

    const CATEGORIES = [
      { id: 'carb', label: 'Carb', color: 'bg-amber-100 text-amber-800 border-amber-300', aisle: 'Pantry' },
      { id: 'protein', label: 'Protein', color: 'bg-red-100 text-red-800 border-red-300', aisle: 'Meat/Dairy' },
      { id: 'fruit',   label: 'Fruit',   color: 'bg-purple-100 text-purple-800 border-purple-300', aisle: 'Produce' },
      { id: 'veggie',  label: 'Veggie',  color: 'bg-green-100 text-green-700 border-green-300', aisle: 'Produce' },
      { id: 'snack',   label: 'Snack',   color: 'bg-blue-100 text-blue-800 border-blue-300', aisle: 'Snacks' },
    ];
    const BALANCE_CATEGORIES = ['carb', 'protein', 'fruit', 'veggie'];
    const RATINGS = [
      { id: 'loves',    icon: 'ph-fill ph-heart',        color: 'text-accent',    label: 'Loves',    min: 7.5 },
      { id: 'likes',    icon: 'ph-fill ph-thumbs-up',    color: 'text-brand-500', label: 'Likes',    min: 5 },
      { id: 'meh',      icon: 'ph-fill ph-minus-circle',  color: 'text-neutral',   label: 'Meh',      min: 2.5 },
      { id: 'dislikes', icon: 'ph-fill ph-thumbs-down',   color: 'text-brand-900', label: 'Dislikes', min: 0 },
    ];
    const EATEN_OPTIONS = [
      { id: 'none', label: 'None', points: 0,  icon: 'ph-fill ph-x-circle',     color: 'text-accent',    bg: 'bg-red-50 border-red-200' },
      { id: 'some', label: 'Some', points: 5,  icon: 'ph-fill ph-minus-circle',  color: 'text-amber-500', bg: 'bg-amber-50 border-amber-200' },
      { id: 'all',  label: 'All',  points: 10, icon: 'ph-fill ph-check-circle',  color: 'text-brand-500', bg: 'bg-brand-50 border-brand-200' },
    ];
    const STOCK_OPTIONS = [
      { id: 'in', label: 'In', icon: 'ph-bold ph-check-circle', color: 'text-brand-500' },
      { id: 'low', label: 'Low', icon: 'ph-bold ph-warning-diamond', color: 'text-neutral' },
      { id: 'out', label: 'Out', icon: 'ph-bold ph-prohibit', color: 'text-accent' },
    ];
    const MEALS = ['breakfast', 'lunch', 'dinner', 'snack'];
    const DAY_LABELS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const CHILD_EMOJIS = ['ðŸ¦Š', 'ðŸ¸', 'ðŸ»', 'ðŸ°', 'ðŸ¦', 'ðŸ±', 'ðŸ¶', 'ðŸ¦„', 'ðŸ¼', 'ðŸ¨', 'ðŸ¦‹', 'ðŸŒŸ'];

    // --- PREFERENCE HELPERS ---
    const getPreferenceScore = (foodId, servings) => {
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      const cutoff = sixMonthsAgo.toLocaleDateString('en-CA');
      const recent = (servings || []).filter(s => s.foodId === foodId && s.date >= cutoff);
      if (recent.length === 0) return { score: null, ratingId: null, rating: null };
      const pointMap = { none: 0, some: 5, all: 10 };
      const total = recent.reduce((sum, s) => sum + (pointMap[s.eaten] ?? 0), 0);
      const score = total / recent.length;
      const r = RATINGS.find(rt => score >= rt.min);
      return { score, ratingId: r?.id || null, rating: r || null };
    };

    const getRecentServings = (foodId, servings, count = 5) => {
      return (servings || []).filter(s => s.foodId === foodId).sort((a, b) => b.date.localeCompare(a.date)).slice(0, count);
    };

    const childServings = (servings, childId) => (servings || []).filter(s => s.childId === childId);
    const childPlans = (plans, childId) => (plans || []).filter(p => p.childId === childId);
    const calculateExposures = (foodId, plans) => (plans || []).filter(p => p.date <= getTodayStr() && p.foodIds.includes(foodId)).length;

    // --- REDUCER ---
    const appReducer = (state, action) => {
      switch (action.type) {
        case 'HYDRATE': return { ...state, ...action.payload, isLoaded: true };
        case 'SYNC_REMOTE': return { ...state, [action.key]: action.data };
        
        case 'ADD_FOOD': {
          const food = { id: generateId(), name: action.name.trim(), categories: action.categories || [], stock: action.stock || 'in', notes: action.notes || '', source: action.source || 'home', createdAt: getTodayStr() };
          return { ...state, foods: [...state.foods, food], lastChanged: { type: 'foods', id: food.id } };
        }
        case 'UPDATE_FOOD': {
          const foods = state.foods.map(f => f.id === action.id ? { ...f, ...action.updates } : f);
          return { ...state, foods, lastChanged: { type: 'foods', id: action.id } };
        }
        case 'DELETE_FOOD': {
          return { ...state, foods: state.foods.filter(f => f.id !== action.id), lastChanged: { type: 'foods', id: action.id, deleted: true } };
        }
        case 'LOG_SERVINGS_BATCH': {
          const newServings = action.entries.map(e => ({ id: generateId(), ...e }));
          return { ...state, servings: [...state.servings, ...newServings], lastChanged: { type: 'servings', batch: newServings } };
        }
        case 'TOGGLE_FOOD_IN_MEAL': {
          const { date, meal, childId, foodId } = action;
          const plan = state.plans.find(p => p.date === date && p.meal === meal && p.childId === childId);
          let newPlans;
          let targetId;
          let deleted = false;
          if (!plan?.foodIds.includes(foodId)) {
            if (plan) {
              targetId = plan.id;
              newPlans = state.plans.map(p => p.id === plan.id ? { ...p, foodIds: [...p.foodIds, foodId] } : p);
            } else {
              const newPlan = { id: generateId(), date, meal, childId, foodIds: [foodId] };
              targetId = newPlan.id;
              newPlans = [...state.plans, newPlan];
            }
          } else {
            targetId = plan.id;
            const updatedPlan = { ...plan, foodIds: plan.foodIds.filter(id => id !== foodId) };
            if (updatedPlan.foodIds.length === 0) {
                deleted = true;
                newPlans = state.plans.filter(p => p.id !== plan.id);
            } else {
                newPlans = state.plans.map(p => p.id === plan.id ? updatedPlan : p);
            }
          }
          return { ...state, plans: newPlans, lastChanged: { type: 'plans', id: targetId, deleted } };
        }
        case 'UPDATE_SETTINGS': return { ...state, settings: { ...state.settings, ...action.updates }, lastChanged: { type: 'settings' } };
        case 'ADD_CHILD': {
           const child = { id: generateId(), name: action.name.trim(), emoji: action.emoji, order: state.children.length, createdAt: getTodayStr() };
           return { ...state, children: [...state.children, child], lastChanged: { type: 'children', id: child.id } };
        }
        case 'UPDATE_CHILD': {
            const children = state.children.map(c => c.id === action.id ? { ...c, ...action.updates } : c);
            return { ...state, children, lastChanged: { type: 'children', id: action.id } };
        }
        default: return state;
      }
    };

    // --- REUSABLE UI COMPONENTS ---
    const Modal = ({ children, onClose }) => (
      <div className="fixed inset-0 z-[100] flex items-center justify-center bg-brand-900/60 p-4 animate-in" onClick={(e) => e.target === e.currentTarget && onClose()}>
        <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-md max-h-[85vh] overflow-y-auto">{children}</div>
      </div>
    );

    const RatingIcon = ({ foodId, servings, ratingId, size = "sm" }) => {
      const id = ratingId || (foodId ? getPreferenceScore(foodId, servings).ratingId : null);
      const r = RATINGS.find(rt => rt.id === id);
      return r ? <i className={`${r.icon} ${r.color} ${size === 'lg' ? 'text-3xl' : 'text-xl'}`}></i> : null;
    };

    const ChildPreferenceBadges = ({ foodId, children, servings }) => {
      if (!children || children.length < 2) return null;
      return (
        <div className="flex gap-1 items-center">
          {children.map(child => {
            const cServings = (servings || []).filter(s => s.childId === child.id);
            const { ratingId } = getPreferenceScore(foodId, cServings);
            const r = RATINGS.find(rt => rt.id === ratingId);
            if (!r) return null;
            return <span key={child.id} className="flex items-center gap-0.5"><span className="text-[10px]">{child.emoji}</span><i className={`${r.icon} ${r.color} text-xs`}></i></span>;
          })}
        </div>
      );
    };

    // --- MAIN APP COMPONENT ---
    function App() {
      const [state, dispatch] = useReducer(appReducer, {
        isLoaded: false, foods: [], plans: [], servings: [], children: [],
        settings: { sameMealDefault: true, activeChildId: null },
        familyCode: localStorage.getItem('familyCode') || null,
        lastChanged: null
      });

      const [tab, setTab] = useState('today');
      const [showGateway, setShowGateway] = useState(!localStorage.getItem('familyCode'));
      const [edit, setEdit] = useState(null);
      const [quickSort, setQuickSort] = useState(false);
      const firebaseRef = useRef({ db: null, auth: null });

      // Firebase Init
      useEffect(() => {
        if (!window.FirebaseLib) return;
        const { initializeApp, getFirestore, getAuth, signInAnonymously } = window.FirebaseLib;
        const app = initializeApp(firebaseConfig);
        firebaseRef.current.db = getFirestore(app);
        firebaseRef.current.auth = getAuth(app);
        signInAnonymously(firebaseRef.current.auth);
      }, []);

      // Real-time Listeners
      useEffect(() => {
        if (!state.familyCode || !firebaseRef.current.db) return;
        const { db } = firebaseRef.current;
        const { collection, onSnapshot, doc } = window.FirebaseLib;

        const syncCollection = (name, stateKey) => {
          return onSnapshot(collection(db, `families/${state.familyCode}/${name}`), (snap) => {
            const data = snap.docs.map(d => d.data());
            dispatch({ type: 'SYNC_REMOTE', key: stateKey, data });
          });
        };

        const uFoods = syncCollection('foods', 'foods');
        const uPlans = syncCollection('plans', 'plans');
        const uServs = syncCollection('servings', 'servings');
        const uKids = syncCollection('children', 'children');
        const uSets = onSnapshot(doc(db, `families/${state.familyCode}/config/settings`), (doc) => {
          if (doc.exists()) dispatch({ type: 'SYNC_REMOTE', key: 'settings', data: doc.data() });
        });

        return () => { uFoods(); uPlans(); uServs(); uKids(); uSets(); };
      }, [state.familyCode]);

      // Push Changes
      useEffect(() => {
        if (!state.lastChanged || !state.familyCode || !firebaseRef.current.db) return;
        const { db } = firebaseRef.current;
        const { doc, setDoc, writeBatch, deleteDoc } = window.FirebaseLib;
        const { type, id, batch, deleted } = state.lastChanged;

        const pushData = async () => {
          if (type === 'settings') {
            await setDoc(doc(db, `families/${state.familyCode}/config/settings`), state.settings);
          } else if (batch) {
            const b = writeBatch(db);
            batch.forEach(item => b.set(doc(db, `families/${state.familyCode}/${type}/${item.id}`), item));
            await b.commit();
          } else if (id) {
            if (deleted) {
                await deleteDoc(doc(db, `families/${state.familyCode}/${type}/${id}`));
            } else {
                const item = state[type].find(x => x.id === id);
                if (item) await setDoc(doc(db, `families/${state.familyCode}/${type}/${id}`), item);
            }
          }
        };
        pushData();
      }, [state.lastChanged]);

      const activeChildId = state.settings?.activeChildId || state.children?.[0]?.id || null;
      const setActiveChildId = (id) => dispatch({ type: 'UPDATE_SETTINGS', updates: { activeChildId: id } });

      if (showGateway) return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-brand-50">
          <div className="bg-white p-8 rounded-[2.5rem] shadow-xl w-full max-w-sm text-center">
            <i className="ph-fill ph-house-line text-6xl text-brand-500 mb-4"></i>
            <h1 className="text-2xl font-black text-brand-900 mb-2">Sync with Partner</h1>
            <p className="text-sm text-neutral font-bold mb-8 leading-relaxed">Create a family code to share your meal data across multiple phones.</p>
            <button onClick={() => { const code = generateFamilyCode(); localStorage.setItem('familyCode', code); dispatch({type:'HYDRATE', payload:{familyCode:code}}); setShowGateway(false); }} className="w-full bg-brand-500 text-white py-4 rounded-2xl font-black uppercase shadow-lg mb-4 active:scale-95 transition-all">Start New Family</button>
            <div className="relative flex items-center py-4"><div className="flex-grow border-t border-slate-100"></div><span className="flex-shrink mx-4 text-[10px] font-black text-slate-300 uppercase">Or Join</span><div className="flex-grow border-t border-slate-100"></div></div>
            <div className="flex gap-2">
                <input type="text" id="joinCode" placeholder="ENTER CODE" className="flex-1 bg-slate-50 border-none rounded-xl px-4 font-black text-center uppercase tracking-widest outline-none" />
                <button onClick={() => { const code = document.getElementById('joinCode').value.toUpperCase(); if(code.length === 6) { localStorage.setItem('familyCode', code); dispatch({type:'HYDRATE', payload:{familyCode:code}}); setShowGateway(false); }}} className="bg-brand-900 text-white px-4 py-3 rounded-xl font-black uppercase text-xs">Join</button>
            </div>
          </div>
        </div>
      );

      const NAV = [ {id:'today', i:'ph-house'}, {id:'pantry', i:'ph-package'}, {id:'library', i:'ph-books'}, {id:'planner', i:'ph-calendar-blank'}, {id:'shopping', i:'ph-shopping-cart'} ];

      return (
        <div className="min-h-screen flex flex-col pt-8">
          <main className="flex-1 max-w-md mx-auto w-full p-6">
             <div className="mb-4 flex justify-between items-center opacity-40">
                <span className="text-[9px] font-black uppercase tracking-widest">Code: {state.familyCode}</span>
                <button onClick={() => { localStorage.removeItem('familyCode'); location.reload(); }} className="text-[9px] font-black uppercase">Switch Family</button>
             </div>

            {state.children.length >= 2 && tab !== 'shopping' && (
              <div className="flex gap-2 items-center overflow-x-auto no-scrollbar pb-2 px-1 mb-4">
                {state.children.sort((a, b) => a.order - b.order).map(child => (
                    <button key={child.id} onClick={() => setActiveChildId(child.id)} className={`flex items-center gap-1.5 px-4 py-2 rounded-2xl text-sm font-black transition-all whitespace-nowrap ${activeChildId === child.id ? 'bg-brand-500 text-white shadow-lg' : 'bg-white text-brand-900 border border-slate-200'}`}><span className="text-base">{child.emoji}</span><span>{child.name}</span></button>
                ))}
              </div>
            )}

            {tab === 'today' && <TodayView foods={state.foods} plans={state.plans} servings={state.servings} dispatch={dispatch} activeChildId={activeChildId} kids={state.children} />}
            {tab === 'pantry' && <ListView foods={state.foods.filter(f => f.stock !== 'out')} plans={state.plans} servings={state.servings} title="Pantry" onEdit={setEdit} kids={state.children} activeId={activeChildId} />}
            {tab === 'library' && <ListView foods={state.foods} plans={state.plans} servings={state.servings} title="Library" onEdit={setEdit} kids={state.children} activeId={activeChildId} />}
            {tab === 'planner' && <MealPlannerView foods={state.foods} plans={state.plans} servings={state.servings} dispatch={dispatch} activeChildId={activeChildId} kids={state.children} settings={state.settings} />}
            {tab === 'shopping' && <ShoppingListView foods={state.foods} servings={state.servings} kids={state.children} dispatch={dispatch} />}
            {tab === 'family' && <FamilySettingsView kids={state.children} dispatch={dispatch} />}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around p-3 pb-8 z-50">
            {NAV.map(t => (<button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center gap-1 transition-all ${tab === t.id ? 'scale-110 text-brand-500' : 'opacity-40 grayscale'}`}><i className={`${tab === t.id ? t.i + '-fill' : t.i} text-2xl`}></i><span className="text-[9px] font-black uppercase tracking-widest">{t.id}</span></button>))}
            <button onClick={() => setTab('family')} className={`flex flex-col items-center gap-1 transition-all ${tab === 'family' ? 'scale-110 text-brand-500' : 'opacity-40 grayscale'}`}><i className={`${tab === 'family' ? 'ph-users-three-fill' : 'ph-users-three'} text-2xl`}></i><span className="text-[9px] font-black uppercase tracking-widest">Family</span></button>
          </nav>

          {edit && <FoodFormModal food={edit} plans={state.plans} servings={state.servings} onSave={(d) => { dispatch({type:'UPDATE_FOOD', id:edit.id, updates:d}); setEdit(null); }} onDelete={() => { dispatch({type:'DELETE_FOOD', id:edit.id}); setEdit(null); }} onClose={() => setEdit(null)} activeChildId={activeChildId} children={state.children} />}
        </div>
      );
    }

    // --- SUB-VIEWS (Today, List, Planner, etc) ---

    function TodayView({ foods, plans, servings, dispatch, activeChildId, kids }) {
      const [checkInMeal, setCheckInMeal] = useState(null);
      const tStr = getTodayStr();
      const myPlans = childPlans(plans, activeChildId);
      const myServings = childServings(servings, activeChildId);

      const uncheckedMeals = MEALS.filter(meal => {
        const plan = myPlans.find(p => p.date === tStr && p.meal === meal);
        if (!plan || plan.foodIds.length === 0) return false;
        return !plan.foodIds.some(fid => myServings.some(s => s.foodId === fid && s.date === tStr && s.meal === meal));
      });

      return (
        <div className="animate-in pb-24">
          <h2 className="text-3xl font-black text-brand-900 tracking-tight mb-6">Today</h2>
          
          {uncheckedMeals.length > 0 ? uncheckedMeals.map(meal => (
            <button key={meal} onClick={() => setCheckInMeal(meal)} className="w-full bg-brand-900 text-white p-6 rounded-[2.5rem] shadow-xl flex items-center justify-between active:scale-95 transition-all mb-4">
               <div className="text-left"><p className="text-xl font-black capitalize">How was {meal}?</p><p className="text-xs opacity-60 font-bold uppercase tracking-widest">Log eating progress</p></div>
               <i className="ph ph-arrow-circle-right text-white text-2xl"></i>
            </button>
          )) : (
            <div className="bg-white p-8 rounded-[2.5rem] text-center mb-6">
                <i className="ph ph-check-circle text-4xl text-brand-500 mb-2"></i>
                <p className="font-black text-brand-900">All caught up!</p>
            </div>
          )}

          <div className="grid grid-cols-2 gap-3">
             <div className="bg-white p-5 rounded-[2rem] shadow-sm">
                <p className="text-[10px] font-black text-neutral uppercase mb-1">Accepted Foods</p>
                <p className="text-3xl font-black text-brand-500">{foods.filter(f => calculateExposures(f.id, myPlans) >= 15).length}</p>
             </div>
             <div className="bg-white p-5 rounded-[2rem] shadow-sm">
                <p className="text-[10px] font-black text-neutral uppercase mb-1">To Buy</p>
                <p className="text-3xl font-black text-accent">{foods.filter(f => f.stock !== 'in').length}</p>
             </div>
          </div>
          
          {checkInMeal && <MealCheckInModal meal={checkInMeal} plans={plans} foods={foods} servings={servings} dispatch={dispatch} onClose={() => setCheckInMeal(null)} activeChildId={activeChildId} children={kids} />}
        </div>
      );
    }

    function ListView({ foods, title, onEdit, kids, servings, plans, activeId }) {
      const [search, setSearch] = useState('');
      const filtered = foods.filter(f => f.name.toLowerCase().includes(search.toLowerCase())).sort((a,b) => a.name.localeCompare(b.name));
      const myPlans = (plans || []).filter(p => p.childId === activeId);

      return (
        <div className="animate-in pb-24">
          <h2 className="text-3xl font-black text-brand-900 mb-4">{title}</h2>
          <input type="text" placeholder="Search..." onChange={e => setSearch(e.target.value)} className="w-full p-4 mb-4 rounded-2xl bg-white shadow-sm font-bold outline-none" />
          <div className="space-y-2">
            {filtered.map(f => (
              <div key={f.id} onClick={() => onEdit(f)} className="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center active:scale-95 transition-all">
                <div>
                    <p className="font-bold">{f.name}</p>
                    <p className="text-[9px] font-black text-neutral uppercase">Tries: {calculateExposures(f.id, myPlans)}</p>
                </div>
                <ChildPreferenceBadges foodId={f.id} children={kids} servings={servings} />
              </div>
            ))}
          </div>
        </div>
      );
    }

    function MealPlannerView({ foods, plans, servings, dispatch, activeChildId, kids, settings }) {
      const date = getTodayStr();
      const myPlans = childPlans(plans, activeChildId);
      const [picker, setPicker] = useState(null);

      return (
        <div className="animate-in pb-24">
          <h2 className="text-3xl font-black text-brand-900 mb-6">Planner</h2>
          <div className="space-y-4">
            {MEALS.map(m => {
              const p = myPlans.find(plan => plan.date === date && plan.meal === m);
              const pf = p?.foodIds.map(id => foods.find(f => f.id === id)).filter(Boolean) || [];
              return (
                <div key={m} onClick={() => setPicker({date, meal:m})} className="bg-white p-6 rounded-[2.5rem] shadow-sm">
                   <h3 className="font-black text-xl capitalize mb-3 text-brand-900">{m}</h3>
                   {pf.length ? pf.map(f => (
                     <div key={f.id} className="bg-brand-50 p-3 rounded-xl mb-1 flex justify-between items-center text-sm font-bold">
                        <span>{f.name}</span>
                        <RatingIcon foodId={f.id} servings={childServings(servings, activeChildId)} />
                     </div>
                   )) : <p className="text-[10px] text-slate-300 font-black uppercase">+ Add Food</p>}
                </div>
              );
            })}
          </div>
          {picker && <FoodPickerModal meal={picker.meal} date={picker.date} foods={foods} current={myPlans.find(p => p.date === picker.date && p.meal === picker.meal)?.foodIds || []} dispatch={dispatch} onClose={() => setPicker(null)} activeId={activeChildId} settings={settings} kids={kids} />}
        </div>
      );
    }

    function ShoppingListView({ foods, servings, kids, dispatch }) {
        const items = foods.filter(f => f.stock !== 'in').sort((a,b) => a.name.localeCompare(b.name));
        return (
            <div className="animate-in pb-24">
                <h2 className="text-3xl font-black text-brand-900 mb-6">Shopping</h2>
                <div className="space-y-2">
                    {items.map(f => (
                        <div key={f.id} className="bg-white p-4 rounded-2xl flex justify-between items-center">
                            <span className="font-bold">{f.name}</span>
                            <button onClick={() => dispatch({type:'UPDATE_FOOD', id:f.id, updates:{stock:'in'}})} className="w-8 h-8 bg-brand-50 rounded-full flex items-center justify-center"><i className="ph ph-check text-brand-500"></i></button>
                        </div>
                    ))}
                </div>
            </div>
        )
    }

    function FamilySettingsView({ kids, dispatch }) {
        const [name, setName] = useState('');
        return (
            <div className="animate-in pb-24">
                <h2 className="text-3xl font-black text-brand-900 mb-6">Family</h2>
                <div className="space-y-3 mb-8">
                    {kids.map(k => (
                        <div key={k.id} className="bg-white p-4 rounded-2xl flex items-center gap-3">
                            <span className="text-2xl">{k.emoji}</span>
                            <span className="font-black">{k.name}</span>
                        </div>
                    ))}
                </div>
                <div className="bg-white p-6 rounded-[2rem]">
                    <p className="text-[10px] font-black uppercase text-neutral mb-2">Add Child</p>
                    <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Name..." className="w-full p-4 bg-brand-50 rounded-xl mb-3 font-bold" />
                    <button onClick={() => { if(name) dispatch({type:'ADD_CHILD', name, emoji:CHILD_EMOJIS[kids.length % CHILD_EMOJIS.length]}); setName(''); }} className="w-full bg-brand-500 text-white py-4 rounded-xl font-black uppercase">Add</button>
                </div>
            </div>
        )
    }

    // --- MODALS ---

    function FoodPickerModal({ meal, date, foods, current, dispatch, onClose, activeId, settings, kids }) {
        return (
            <Modal onClose={onClose}>
                <div className="p-6">
                    <h2 className="text-2xl font-black mb-4 capitalize">Add to {meal}</h2>
                    <div className="space-y-2 max-h-96 overflow-y-auto no-scrollbar">
                        {foods.map(f => {
                            const sel = current.includes(f.id);
                            return (
                                <button key={f.id} onClick={() => {
                                    const targets = settings.sameMealDefault ? kids.map(k => k.id) : [activeId];
                                    targets.forEach(cid => dispatch({type:'TOGGLE_FOOD_IN_MEAL', date, meal, childId:cid, foodId:f.id}));
                                }} className={`w-full p-4 rounded-xl text-left font-bold border-2 transition-all ${sel ? 'bg-brand-100 border-brand-500' : 'bg-white border-slate-100'}`}>
                                    {f.name}
                                </button>
                            )
                        })}
                    </div>
                    <button onClick={onClose} className="w-full bg-brand-900 text-white py-4 rounded-2xl font-black uppercase mt-6">Done</button>
                </div>
            </Modal>
        )
    }

    function MealCheckInModal({ meal, plans, foods, servings, dispatch, onClose, activeChildId, children }) {
        const date = getTodayStr();
        const plan = plans.find(p => p.date === date && p.meal === meal && p.childId === activeChildId);
        const mealFoods = (plan?.foodIds || []).map(id => foods.find(f => f.id === id)).filter(Boolean);
        const [logs, setLogs] = useState({});

        const handleSave = () => {
            const entries = Object.entries(logs).map(([foodId, eaten]) => ({ foodId, date, meal, childId:activeChildId, eaten }));
            dispatch({type:'LOG_SERVINGS_BATCH', entries});
            onClose();
        };

        return (
            <Modal onClose={onClose}>
                <div className="p-8">
                    <h2 className="text-2xl font-black mb-6 capitalize">{meal} Check-in</h2>
                    {mealFoods.map(f => (
                        <div key={f.id} className="mb-6">
                            <p className="font-black text-brand-900 mb-3">{f.name}</p>
                            <div className="flex gap-2">
                                {EATEN_OPTIONS.map(opt => (
                                    <button key={opt.id} onClick={() => setLogs(p => ({...p, [f.id]: opt.id}))} className={`flex-1 py-3 rounded-xl border-2 flex flex-col items-center gap-1 ${logs[f.id] === opt.id ? opt.bg + ' border-current' : 'bg-white opacity-40'}`}>
                                        <i className={`${opt.icon} ${opt.color} text-xl`}></i>
                                        <span className="text-[8px] font-black uppercase">{opt.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ))}
                    <button onClick={handleSave} className="w-full bg-brand-500 text-white py-5 rounded-3xl font-black uppercase shadow-xl">Save Progress</button>
                </div>
            </Modal>
        )
    }

    function FoodFormModal({ food, plans, servings, onSave, onDelete, onClose, children, activeChildId }) {
        const [name, setName] = useState(food.name);
        const [stock, setStock] = useState(food.stock);
        return (
            <Modal onClose={onClose}>
                <div className="p-8">
                    <input type="text" value={name} onChange={e => setName(e.target.value)} className="text-2xl font-black w-full outline-none mb-6" />
                    <p className="text-[10px] font-black uppercase text-neutral mb-2">Stock Level</p>
                    <div className="flex gap-2 mb-8">
                        {STOCK_OPTIONS.map(s => (
                            <button key={s.id} onClick={() => setStock(s.id)} className={`flex-1 py-4 rounded-xl border-2 font-black text-[10px] uppercase ${stock === s.id ? 'bg-brand-100 border-brand-500' : 'bg-white border-slate-100 opacity-40'}`}>{s.label}</button>
                        ))}
                    </div>
                    <button onClick={() => onSave({name, stock})} className="w-full bg-brand-500 text-white py-5 rounded-3xl font-black uppercase shadow-xl mb-2">Save</button>
                    <button onClick={onDelete} className="w-full py-3 text-accent font-black uppercase text-[10px]">Delete Food</button>
                </div>
            </Modal>
        )
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>