--- START OF FILE text/html ---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Meal Tracker Sync</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/meal-tracker/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#167188" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCWPs2eVMJSCzG3f0YLMjL_PCT7ozYnCjM",
    	authDomain: "cd-meal-tracker.firebaseapp.com",
    	projectId: "cd-meal-tracker",
    	storageBucket: "cd-meal-tracker.firebasestorage.app",
    	messagingSenderId: "263676843677",
    	appId: "1:263676843677:web:532e95fb0b879e9e67e674",
    	measurementId: "G-R3DVDM36Z5"
    };

    window.FirebaseLib = { initializeApp, getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, writeBatch, getAuth, signInAnonymously };
  </script>

  <script>
    tailwind.config = {
      theme: { extend: { colors: {
        brand: { 50: '#f0f7f9', 100: '#daebf1', 500: '#167188', 900: '#0D4250' },
        accent: '#FF6B6B', neutral: '#7E7F7F'
      } } }
    }
  </script>
  <style>
    body { padding-bottom: env(safe-area-inset-bottom); background: #f0f7f9; -webkit-tap-highlight-color: transparent; }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="text-slate-800 tracking-tight">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useReducer, useCallback, useMemo, useRef } = React;

    // --- FIREBASE SYNC HELPERS ---
    const generateFamilyCode = () => {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      return Array.from({length: 6}, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
    };

    // --- DB WRAPPER (Local Fallback) ---
    const DB_NAME = 'MealTrackerDB';
    const dbSaveLocal = async (key, data) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onsuccess = (e) => {
        const db = e.target.result;
        const tx = db.transaction('appData', 'readwrite');
        tx.objectStore('appData').put(data, key);
      };
    };
    const dbLoadLocal = (key, defaultValue) => {
      return new Promise((resolve) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => e.target.result.createObjectStore('appData');
        request.onsuccess = (e) => {
          const tx = e.target.result.transaction('appData', 'readonly');
          const req = tx.objectStore('appData').get(key);
          req.onsuccess = () => resolve(req.result || defaultValue);
          req.onerror = () => resolve(defaultValue);
        };
      });
    };

    const generateId = () => Math.random().toString(36).substring(2, 15);
    const getTodayStr = () => new Date().toLocaleDateString('en-CA');

    // (Constants CATEGORIES, RATINGS, EATEN_OPTIONS, etc. same as original)
    const CATEGORIES = [
      { id: 'carb', label: 'Carb', color: 'bg-amber-100 text-amber-800 border-amber-300', aisle: 'Pantry' },
      { id: 'protein', label: 'Protein', color: 'bg-red-100 text-red-800 border-red-300', aisle: 'Meat/Dairy' },
      { id: 'fruit',   label: 'Fruit',   color: 'bg-purple-100 text-purple-800 border-purple-300', aisle: 'Produce' },
      { id: 'veggie',  label: 'Veggie',  color: 'bg-green-100 text-green-700 border-green-300', aisle: 'Produce' },
      { id: 'snack',   label: 'Snack',   color: 'bg-blue-100 text-blue-800 border-blue-300', aisle: 'Snacks' },
    ];
    const BALANCE_CATEGORIES = ['carb', 'protein', 'fruit', 'veggie'];
    const RATINGS = [
      { id: 'loves',    icon: 'ph-fill ph-heart',        color: 'text-accent',    label: 'Loves',    min: 7.5 },
      { id: 'likes',    icon: 'ph-fill ph-thumbs-up',    color: 'text-brand-500', label: 'Likes',    min: 5 },
      { id: 'meh',      icon: 'ph-fill ph-minus-circle',  color: 'text-neutral',   label: 'Meh',      min: 2.5 },
      { id: 'dislikes', icon: 'ph-fill ph-thumbs-down',   color: 'text-brand-900', label: 'Dislikes', min: 0 },
    ];
    const EATEN_OPTIONS = [
      { id: 'none', label: 'None', points: 0,  icon: 'ph-fill ph-x-circle',     color: 'text-accent',    bg: 'bg-red-50 border-red-200' },
      { id: 'some', label: 'Some', points: 5,  icon: 'ph-fill ph-minus-circle',  color: 'text-amber-500', bg: 'bg-amber-50 border-amber-200' },
      { id: 'all',  label: 'All',  points: 10, icon: 'ph-fill ph-check-circle',  color: 'text-brand-500', bg: 'bg-brand-50 border-brand-200' },
    ];
    const STOCK_OPTIONS = [
      { id: 'in', label: 'In', icon: 'ph-bold ph-check-circle', color: 'text-brand-500' },
      { id: 'low', label: 'Low', icon: 'ph-bold ph-warning-diamond', color: 'text-neutral' },
      { id: 'out', label: 'Out', icon: 'ph-bold ph-prohibit', color: 'text-accent' },
    ];
    const MEALS = ['breakfast', 'lunch', 'dinner', 'snack'];
    const DAY_LABELS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const CHILD_EMOJIS = ['ðŸ¦Š', 'ðŸ¸', 'ðŸ»', 'ðŸ°', 'ðŸ¦', 'ðŸ±', 'ðŸ¶', 'ðŸ¦„', 'ðŸ¼', 'ðŸ¨', 'ðŸ¦‹', 'ðŸŒŸ'];

    // --- PREFERENCE HELPERS ---
    const getPreferenceScore = (foodId, servings) => {
      const sixMonthsAgo = new Date();
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      const cutoff = sixMonthsAgo.toLocaleDateString('en-CA');
      const recent = (servings || []).filter(s => s.foodId === foodId && s.date >= cutoff);
      if (recent.length === 0) return { score: null, ratingId: null, rating: null };
      const pointMap = { none: 0, some: 5, all: 10 };
      const total = recent.reduce((sum, s) => sum + (pointMap[s.eaten] ?? 0), 0);
      const score = total / recent.length;
      const r = RATINGS.find(rt => score >= rt.min);
      return { score, ratingId: r?.id || null, rating: r || null };
    };

    // --- REDUCER ---
    const appReducer = (state, action) => {
      switch (action.type) {
        case 'HYDRATE': return { ...state, ...action.payload, isLoaded: true };
        case 'SYNC_REMOTE': return { ...state, [action.key]: action.data };
        
        case 'ADD_FOOD': {
          const food = { id: generateId(), name: action.name.trim(), categories: action.categories || [], stock: action.stock || 'in', notes: action.notes || '', source: action.source || 'home', createdAt: getTodayStr() };
          return { ...state, foods: [...state.foods, food], lastChanged: { type: 'foods', id: food.id } };
        }
        case 'UPDATE_FOOD': {
          const foods = state.foods.map(f => f.id === action.id ? { ...f, ...action.updates } : f);
          return { ...state, foods, lastChanged: { type: 'foods', id: action.id } };
        }
        case 'LOG_SERVINGS_BATCH': {
          const newServings = action.entries.map(e => ({ id: generateId(), ...e }));
          return { ...state, servings: [...state.servings, ...newServings], lastChanged: { type: 'servings', batch: newServings } };
        }
        case 'TOGGLE_FOOD_IN_MEAL': {
          const { date, meal, childId, foodId } = action;
          const plan = state.plans.find(p => p.date === date && p.meal === meal && p.childId === childId);
          let newPlans;
          let targetId;
          if (!plan?.foodIds.includes(foodId)) {
            if (plan) {
              targetId = plan.id;
              newPlans = state.plans.map(p => p.id === plan.id ? { ...p, foodIds: [...p.foodIds, foodId] } : p);
            } else {
              const newPlan = { id: generateId(), date, meal, childId, foodIds: [foodId] };
              targetId = newPlan.id;
              newPlans = [...state.plans, newPlan];
            }
          } else {
            targetId = plan.id;
            newPlans = state.plans.map(p => p.id === plan.id ? { ...p, foodIds: p.foodIds.filter(id => id !== foodId) } : p).filter(p => p.foodIds.length > 0);
          }
          return { ...state, plans: newPlans, lastChanged: { type: 'plans', id: targetId } };
        }
        // ... (Other actions remain essentially the same, just flagging state.lastChanged)
        case 'UPDATE_SETTINGS': return { ...state, settings: { ...state.settings, ...action.updates }, lastChanged: { type: 'settings' } };
        default: return state;
      }
    };

    // --- MAIN COMPONENT ---
    function App() {
      const [state, dispatch] = useReducer(appReducer, {
        isLoaded: false, foods: [], plans: [], servings: [], children: [],
        settings: { sameMealDefault: true, activeChildId: null },
        familyCode: localStorage.getItem('familyCode') || null,
        lastChanged: null
      });

      const [showGateway, setShowGateway] = useState(!localStorage.getItem('familyCode'));
      const firebaseRef = useRef({ db: null, auth: null });

      // 1. Initialize Firebase & Auth
      useEffect(() => {
        if (!window.FirebaseLib) return;
        const { initializeApp, getFirestore, getAuth, signInAnonymously } = window.FirebaseLib;
        const app = initializeApp(firebaseConfig);
        firebaseRef.current.db = getFirestore(app);
        firebaseRef.current.auth = getAuth(app);
        signInAnonymously(firebaseRef.current.auth);
      }, []);

      // 2. Real-time Listeners
      useEffect(() => {
        if (!state.familyCode || !firebaseRef.current.db) return;
        const { db } = firebaseRef.current;
        const { collection, onSnapshot, query, doc } = window.FirebaseLib;

        const syncCollection = (name, stateKey) => {
          return onSnapshot(collection(db, `families/${state.familyCode}/${name}`), (snap) => {
            const data = snap.docs.map(d => d.data());
            // Only update if remote data is different to avoid loops
            dispatch({ type: 'SYNC_REMOTE', key: stateKey, data });
          });
        };

        // Sync main collections
        const unsubFoods = syncCollection('foods', 'foods');
        const unsubPlans = syncCollection('plans', 'plans');
        const unsubServings = syncCollection('servings', 'servings');
        const unsubChildren = syncCollection('children', 'children');

        // Sync settings (single doc)
        const unsubSettings = onSnapshot(doc(db, `families/${state.familyCode}/config/settings`), (doc) => {
          if (doc.exists()) dispatch({ type: 'SYNC_REMOTE', key: 'settings', data: doc.data() });
        });

        return () => { unsubFoods(); unsubPlans(); unsubServings(); unsubChildren(); unsubSettings(); };
      }, [state.familyCode]);

      // 3. Persistence Effect (Push to Firebase)
      useEffect(() => {
        if (!state.lastChanged || !state.familyCode || !firebaseRef.current.db) return;
        const { db } = firebaseRef.current;
        const { doc, setDoc, writeBatch } = window.FirebaseLib;
        const { type, id, batch } = state.lastChanged;

        const pushData = async () => {
          if (type === 'settings') {
            await setDoc(doc(db, `families/${state.familyCode}/config/settings`), state.settings);
          } else if (batch) {
            const b = writeBatch(db);
            batch.forEach(item => b.set(doc(db, `families/${state.familyCode}/${type}/${item.id}`), item));
            await b.commit();
          } else if (id) {
            const item = state[type].find(x => x.id === id);
            if (item) {
              await setDoc(doc(db, `families/${state.familyCode}/${type}/${id}`), item);
            }
          }
        };
        pushData();
      }, [state.lastChanged]);

      const handleJoinFamily = async (code) => {
        const cleanCode = code.toUpperCase().trim();
        localStorage.setItem('familyCode', cleanCode);
        dispatch({ type: 'HYDRATE', payload: { familyCode: cleanCode } });
        setShowGateway(false);
      };

      const handleCreateFamily = async () => {
        const newCode = generateFamilyCode();
        // Option to "Upload existing data" here
        handleJoinFamily(newCode);
      };

      if (showGateway) return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-brand-50">
          <div className="bg-white p-8 rounded-[2.5rem] shadow-xl w-full max-w-sm text-center">
            <i className="ph-fill ph-house-line text-6xl text-brand-500 mb-4"></i>
            <h1 className="text-2xl font-black text-brand-900 mb-2">Sync with Partner</h1>
            <p className="text-sm text-neutral font-bold mb-8 leading-relaxed">Create a family code to share your meal data across multiple phones.</p>
            
            <button onClick={handleCreateFamily} className="w-full bg-brand-500 text-white py-4 rounded-2xl font-black uppercase shadow-lg mb-4 active:scale-95 transition-all">Start New Family</button>
            
            <div className="relative flex items-center py-4">
              <div className="flex-grow border-t border-slate-100"></div>
              <span className="flex-shrink mx-4 text-[10px] font-black text-slate-300 uppercase">Or Join</span>
              <div className="flex-grow border-t border-slate-100"></div>
            </div>

            <JoinInput onJoin={handleJoinFamily} />
          </div>
        </div>
      );

      // (Rest of the UI: TodayView, ListView, etc. - same as original)
      return (
        <div className="min-h-screen flex flex-col pt-8">
          <div className="max-w-md mx-auto w-full px-6 flex justify-between items-center opacity-50">
            <span className="text-[10px] font-black uppercase tracking-widest text-brand-900">
              <i className="ph ph-users-three mr-1"></i> Family: {state.familyCode}
            </span>
            <button onClick={() => { localStorage.removeItem('familyCode'); location.reload(); }} className="text-[8px] font-black uppercase">Leave</button>
          </div>
          {/* Render your original components here... */}
          <p className="p-10 text-center font-bold text-neutral">App UI Content Goes Here</p>
        </div>
      );
    }

    const JoinInput = ({ onJoin }) => {
      const [val, setVal] = useState('');
      return (
        <div className="flex gap-2">
          <input type="text" value={val} onChange={e => setVal(e.target.value)} placeholder="Enter Code" className="flex-1 bg-slate-50 border-none rounded-xl px-4 font-black text-center uppercase tracking-widest outline-none" />
          <button onClick={() => val.length === 6 && onJoin(val)} className="bg-brand-900 text-white px-4 py-3 rounded-xl font-black uppercase text-xs active:scale-95 transition-all">Join</button>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>